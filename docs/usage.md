# Migration Tool Usage Instruction and Examples

This is the complete utilization guide for this tool, these next sections will explain how this application works and how users can do a complete XML migration to the SciELO Publishing Framework.
- Packing **synthetized** XML files or **native** XML files
- Registering packages on the SPF

## Generating and Packing Synthetized XML files
1. Obtaining HTML documents
2. [Converting HTML to XML documents](#2-\--converting-html-to-xml-documents)
3. [Updating documents' mixed citations](#3-\--updating-documents-mixed-citations)
4. [Packing synthetized XML files](#4-\--packing-synthetized-xml-files)

## Packing Native XML files
1. [Packing Native XML files](#1-\--packing-native-xml-files)

## Registering packages on the SPF
5. Importing documents packages to the Publish Platform
6. Committing the relationship between documents and issues
   
## Checking migration
7. [Check similarity between sites](#7-\--check-similarity-between-sites)

## 2 - Converting HTML to XML documents

The documents at this point are XML, but their body content is not XML, but escaped HTML, for example:

```xml
<body>
&lt;text find=&quot;text_2&quot;&gt;This is the home page of SciELO Brasil Site.&lt;br&gt;
			&lt;br&gt;The objective of the site is to implement an electronic virtual library, providing full access to a collection of serial titles, a collection of issues from individual serial titles, as well as to the full text of articles. The access to both serial titles and articles is available via indexes and search forms.&lt;br&gt;
			&lt;br&gt;SciELO site is an integral part of the FAPESP/BIREME/CNPq Project and it is an application of the methodology being developed by the project, particularly the Internet Interface module.&lt;br&gt;
			&lt;br&gt;The site will be constantly updated both in form and content, according to the project's advancements.&lt;/text&gt;
</body>
```

### 2.1 - Setting the environment variables

The variables used are:

- `SOURCE_PATH`: inform the location of _downloaded XML files_ (generated by 1. Obtaining HTML documents)
- `CONVERSION_PATH`: inform the location of _converted XML files_


### 2.2 - Executing the command

To convert only one file, execute:
```shell
ds_migracao convert --file <XML FILE PATH>
```

To convert all the files located in `SOURCE_PATH`, execute:
```shell
ds_migracao convert
```

To log any difference found between the _pipes_, use `--spy`, but it takes much longer:
```shell
ds_migracao convert --spy
```

At the end, the log file created is `migration.log` and all the files converted will be in `CONVERSION_PATH`

By default, if there is difference between the initial and final texts, it is registered in `migration.log` (search by `"pipe": "final"`), so for more detail, execute the command with `--spy` only for the files you found `"pipe": "final"`.


## 3 - Updating documents' mixed citations

The documents must have their mixed citations updated, its important to preserve the quality of your collection. The information stored in the articles' database or paragraphs' databases is essential to finish this task, then please make sure you have access to these databases.

First, locate the database where articles paragraphs are located, this location can vary according to the strategy adopted by the collection. In the SciELO Brazil this information is in two points, these are:
- [1] Articles master file (`/databases/article/article.mst`)
- [2] Articles paragraphs files (`/database/article/p/**/*.mst`)

### 3.1 - Creating paragraphs cache

For this guide, we will work with the first option [1] then all examples will use this source as the paragraphs database. In your terminal execute the command:

```shell
ds_migracao mixed-citations --help
```

You should see the two commands available (`set-cache` and `update`) and a short usage text. Be free to read the text and back here to continue.

The first command `set-cache` should be executed at least one time before the XML updates. So let us create our paragraphs cache database using it (it may take some time according to the database size).

```shell
ds_migracao mixed-citations set-cache /databases/article/article.mst
```

Wait until the commands finish (it will count as zero until that) and see if paragraphs files were created as expected. Open the folder `xml/paragraphs` and see the files.

### 3.2 - Updating articles' mixed citations

The second command `update` must be executed after `set-cache` command, so execute:
```shell
ds_migracao mixed-citations update xml/conversion
```

It may take some time depending on the quantity of XMLs you are updating. For comparison updating `24.000` articles will take approximately 1 hour.

After the command finishes, you will have articles' mixed-citations updated if everything works as expected.

### 3.3 - Troubleshooting

It is important to make sure if everything works and if all articles were updated for that you should pay attention to all error logging printed in the terminal or inside the migration log directory.

Look closer to messages like `file not found` or `access denied` during previous commands.

## 4 - Packing synthetized XML files

Documents Packages is the phase in which we create packages with all the necessary adjustments to be stored in a data store.

This phase is also necessary so that the renditions and assets are all available and accessible via the xml file.

In order to run the `` packing`` phase, it is necessary to perform some predicted configurations, therefore, it is necessary to add two environment variables `` SOURCE_PDF_FILE`` and `` SOURCE_IMG_FILE``.

By default, these variables have the values:

SOURCE_IMG_FILE = "bases"
SOURCE_PDF_FILE = "htdocs"

You can change these values by creating the following environment variables:

```shell
export SOURCE_IMG_FILE = path
export SOURCE_PDF_FILE = path
```

To run the packing, it is possible with the following command:

```shell
ds_migracao --loglevel DEBUG pack
```

Optionally it is possible to run the pack for only one xml, see:

```shell
ds_migracao --loglevel DEBUG pack -f path
```

Optionally it is possible add `<issn/>` to the packages which the `issn` elements are missing:

```shell
ds_migracao --loglevel DEBUG pack --issns-jsonfile issns.json
```

where `issns.json` content format is like:
```json
{
  "1234-0987": {"epub":  "1234-0987", "ppub": "3456-0987"},
  "3456-0987": {"epub":  "1234-0987", "ppub": "3456-0987"},
  "1264-5900": {"epub":  "1264-5900", "ppub": "6456-5900"},
  "6456-5900": {"epub":  "1264-5900", "ppub": "6456-5900"}
}

```

Help:

```shell
ds_migracao --loglevel DEBUG pack --help
```

## 7 - Check similarity between sites


Check_similarity command it is possible to make a comparison between the new site and the old site, in order to assess the similarity between the sites.

In this command it is possible to determine a cut-off mark of how much it is considering an article similar to another.

Example:

```shell
ds_migracao check_similarity --similarity_input pids.txt --similarity_output similarity.jsonl --cut_off_mark=99
```

This command outputs a json file where you can later evaluate the result, example:

```shell
cat similarity | jq 'select(.similarity[0:5]|tonumber>90)'
```
